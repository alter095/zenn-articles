---
title: "nginx-proxyã§410 Goneã‚’è¿”ã™"
emoji: "ğŸ‹"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Docker", "nginx", "ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·"]
published: false
---
# ã¯ã˜ã‚ã«
ä¾‹ãˆã°Mastodonã‚„Misskeyã®é‹ç”¨ã‚’ã‚„ã‚ãŸã„æ™‚ã€ã—ã°ã‚‰ãã¯410 Goneã‚’è¿”ã™ã‚ˆã†ã«ã—ã¦ãŠãã¨è‰¯ã„ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚  
è¿”ã—æ–¹ã¯ç’°å¢ƒã«ã‚ˆã£ã¦å¤‰ã‚ã‚‹ã®ã§ã€1ä¾‹ã¨ã—ã¦æ›¸ãæ®‹ã—ã¦ãŠãã¾ã™ã€‚
 # ç’°å¢ƒ
-  nginx 1.23.3
- [jwilder/nginx-proxy](https://hub.docker.com/r/jwilder/nginx-proxy)
- [nginxproxy/acme-companion](https://hub.docker.com/r/nginxproxy/acme-companion)
# æ‰‹é †
1. docker-compose.ymlã®ç·¨é›†
1. my_proxy.confã®è¨­å®š
## docker-compose.ymlã®ç·¨é›†
`my_proxy.conf`ã‚’`docker-compose.yml`ã¨åŒã˜å ´æ‰€ã«ç”¨æ„ã—ã€ãã‚Œã‚’èª­ã¿å–ã£ã¦åæ˜ ã—ã¦ã‚‚ã‚‰ã†ã‚ˆã†ã«ã—ã¾ã™ã€‚
```yaml:docker-compose.yml
   reverse-proxy:
        image: "jwilder/nginx-proxy:latest"
        container_name: "reverse-proxy"
        volumes:
            - "html:/usr/share/nginx/html"
            - "dhparam:/etc/nginx/dhparam"
            - "vhost:/etc/nginx/vhost.d"
            - "certs:/etc/nginx/certs"
            - "/run/docker.sock:/tmp/docker.sock:ro"
            - "./client_max_upload_size.conf:/etc/nginx/conf.d/client_max_upload_size.conf"
            # ä»Šå›è¿½åŠ 
            - "./my_proxy.conf:/etc/nginx/conf.d/my_proxy.conf:ro"
        restart: "always"
        networks:
            - "net"
        ports:
            - "80:80"
            - "443:443"
```
## my_proxy.confã®è¨­å®š
ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã„ã¦ã„ãã¾ã™ã€‚  
ä»Šå›ã¯ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã®1ã¤ã‚’é–‰é–ã—ãŸã‹ã£ãŸã®ã§ã€`server_name`ã«ç‰¹å®šã®ã‚‚ã®ã‚’æŒ‡å®šã—ã¾ã™ã€‚  
ã¾ãŸã€httpsã«ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«2ç¨®é¡æ›¸ãã“ã¨ã«ã—ã¾ã—ãŸã€‚
```nginx:my_proxy.conf
server {
    listen 80;
    server_name sub.example.com;
   return 410;
}
server {
    listen 443 ssl;
    server_name sub.example.com;
    return 410;
}
```
çµ‚ã‚ã£ãŸã‚‰ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’å†èµ·å‹•ã—ã¦å®Œäº†ã§ã™ã€‚
# ã¾ã¨ã‚
`/etc/nginx/conf.d/my_proxy.conf`ã«è¨­å®šã‚’æ›¸ãã“ã¨ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã™ã“ã¨ãŒã§ããã†ã§ã™ã€‚  
ã“ã®æ‰‹ã®ç›®çš„ã«å¯¾ã™ã‚‹æ–¹æ³•ã¯ã€è¤‡æ•°è¦‹ã¤ã‹ã‚‹ä»£ã‚ã‚Šã«è‡ªç’°å¢ƒã«åˆã£ãŸã‚‚ã®ãŒã‚ã‚‹ã¨ã¯é™ã‚‰ãªã„ã®ã§ã€å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚